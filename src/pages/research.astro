---
import Layout from '@/layouts/Layout.astro';
import { getCollection } from 'astro:content';
import Breadcrumbs from '@/components/Breadcrumbs.svelte';
import { SITE } from '@/config';
import { getBreadcrumbSchema } from '@/lib/schemas';
import { formatDate } from '@/lib/utils/date';

const schema = getBreadcrumbSchema([
  { name: 'Research', url: new URL('/research', Astro.site).toString() },
]);

const researchProjects = (await getCollection('research')).sort(
  (a, b) => a.data.order - b.data.order
);

const formatRange = (start?: Date, end?: Date) => {
  if (!start && !end) return null;
  if (start && !end) return `${formatDate(start)} - Present`;
  if (!start && end) return formatDate(end);
  return `${formatDate(start)} - ${formatDate(end)}`;
};
---

<Layout title="Research" description={SITE.researchDescription} schema={schema}>
  <Breadcrumbs items={[{ name: 'Research', href: '/research' }]} />

  <div class="mb-12 sm:mb-16 lg:mb-20">
    <h1
      class="text-3xl sm:text-4xl lg:text-5xl 3xl:text-6xl font-black tracking-tight text-foreground leading-[1.1]"
    >
      Research
    </h1>
    <p class="mt-4 text-base sm:text-lg lg:text-xl text-muted-foreground max-w-3xl leading-relaxed">
      {SITE.researchDescription}
    </p>
  </div>

  <section class="mb-16 sm:mb-20">
    <div class="flex items-baseline justify-between mb-6 sm:mb-8">
      <h2 class="text-xs font-bold uppercase tracking-[0.2em] text-muted-foreground">
        Research Projects
      </h2>
      <div class="h-px flex-1 mx-4 sm:mx-8 bg-border opacity-70" />
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
      {
        researchProjects.map((project) => {
          const isExternal = project.data.directLink && Boolean(project.data.link);
          const projectUrl = isExternal ? project.data.link : `/research/${project.id}`;
          const target = isExternal ? '_blank' : '_self';
          const dateRange = formatRange(project.data.startDate, project.data.endDate);

          return (
            <article class="flex flex-col h-full p-6 rounded-2xl bg-secondary/30 border border-border/50 hover:bg-secondary/50 hover:border-border transition-all duration-300 group">
              <div class="flex-1">
                <div class="flex items-start justify-between gap-4 mb-3">
                  <a
                    href={projectUrl}
                    target={target}
                    rel={isExternal ? 'noopener noreferrer' : undefined}
                    class="no-underline"
                  >
                    <h2 class="text-xl sm:text-2xl font-bold leading-tight group-hover:text-primary transition-colors">
                      {project.data.title}
                    </h2>
                  </a>
                  <span
                    class={`inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide ${
                      project.data.status === 'ongoing'
                        ? 'bg-emerald-500/15 text-emerald-700 dark:text-emerald-300 border border-emerald-500/30'
                        : project.data.status === 'under review'
                          ? 'bg-amber-500/15 text-amber-700 dark:text-amber-300 border border-amber-500/30'
                          : project.data.status === 'completed'
                            ? 'bg-indigo-500/15 text-indigo-700 dark:text-indigo-300 border border-indigo-500/30'
                            : 'bg-slate-500/10 text-slate-700 dark:text-slate-300 border border-slate-500/20'
                    }`}
                  >
                    {project.data.status === 'under review'
                      ? 'Under Review'
                      : project.data.status}
                  </span>
                </div>

                {dateRange && (
                  <p class="text-xs font-semibold uppercase tracking-widest text-muted-foreground mb-3">
                    {dateRange}
                  </p>
                )}

                <p class="text-sm sm:text-base text-muted-foreground leading-relaxed mb-4">
                  {project.data.description}
                </p>

                {project.data.collaborators.length > 0 && (
                  <p class="text-xs text-muted-foreground mb-4">
                    <span class="font-semibold uppercase tracking-widest text-[10px] text-muted-foreground/70">
                      Collaborators
                    </span>
                    <span class="ml-2">{project.data.collaborators.join(', ')}</span>
                  </p>
                )}

                <div class="flex flex-wrap gap-2 mb-4">
                  {project.data.tags.map((tag) => (
                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-background border border-border text-muted-foreground">
                      {tag}
                    </span>
                  ))}
                </div>
              </div>

              <div class="flex flex-wrap items-center gap-3 pt-4 border-t border-border/50">
                <a
                  href={projectUrl}
                  target={target}
                  rel={isExternal ? 'noopener noreferrer' : undefined}
                  class="inline-flex items-center gap-2 text-sm font-medium text-foreground hover:text-primary transition-colors no-underline"
                >
                  {isExternal ? 'Visit Project website' : 'View Details'}
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <>
                      <path d="M7 7h10v10" />
                      <path d="M7 17 17 7" />
                    </>
                  </svg>
                </a>

                {project.data.links.map((link) => (
                  <a
                    href={link.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-widest text-muted-foreground hover:text-foreground transition-colors no-underline"
                  >
                    {link.label}
                  </a>
                ))}
              </div>
            </article>
          );
        })
      }
    </div>
  </section>

</Layout>
